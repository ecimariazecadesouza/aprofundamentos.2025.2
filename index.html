<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin PRO â€¢ Aprofundamentos 2025.2</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
Â  :root { 
Â  Â  --bg: #0b0e17; --card: #131a2b; --card-2:#0f1526; --card-hover: #19223a;
Â  Â  --txt: #ecf1f6; --muted: #9aa3b2; --accent: #4CAF50; --accent-2:#2fd180;
Â  Â  --error:#ff6b7a; --warn:#ffa726; --line:#1f2740; --shadow: rgba(0,0,0,.25);
Â  Â  --gradient: linear-gradient(135deg, var(--accent), #66BB6A);
Â  }
Â  * { box-sizing: border-box; margin:0; padding:0; }
Â  body { background: radial-gradient(1200px 600px at 10% -10%, rgba(76,175,80,.07), transparent), linear-gradient(120deg,#0a0d14,#0e1322 45%,#0a1230); color:var(--txt); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; }
Â  .container { max-width: 1300px; margin:0 auto; padding:28px 20px; }
Â  .header h1 { font-size: 2.2rem; font-weight: 800; margin:0 0 8px; background:var(--gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
Â  .header p { color:var(--muted); }
Â  .row { display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
Â  .card { background:var(--card); border:1px solid var(--line); border-radius:18px; padding:18px; box-shadow:0 8px 30px var(--shadow); }
Â  .card:hover { background:var(--card-hover); }
Â  .card-title { display:flex; align-items:center; gap:10px; font-weight:800; margin-bottom:10px; }
Â  .muted { color:var(--muted); }
Â  label { font-size:.95rem; font-weight:700; }
Â  input, select, button { background:#0f1426; color:var(--txt); border:1px solid var(--line); border-radius:14px; padding:12px 14px; font:inherit; }
Â  input:focus,select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(76,175,80,.15); }
Â  .btn { background:var(--gradient); border:none; font-weight:800; cursor:pointer; }
Â  .btn.secondary { background:#1a2138; }
Â  .btn.small { padding:8px 10px; border-radius:10px; font-size:.9rem; }
Â  .btn.danger { background:linear-gradient(135deg,#ff4757,#ff6b7a); }
Â  .btn.warn { background:linear-gradient(135deg,#ffa726,#ffb74d); }
Â  .btn.success { background:linear-gradient(135deg,#2ed573,#2fd180); }
Â  .grid { display:grid; gap:14px; }
Â  .grid-2 { grid-template-columns: 1fr; }
Â  .grid-3 { grid-template-columns: 1fr; }
Â  @media (min-width: 860px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }
Â  table { width:100%; border-collapse: collapse; }
Â  th, td { padding:14px 12px; border-bottom: 1px solid var(--line); }
Â  th { text-align:left; font-size:.85rem; letter-spacing:.5px; text-transform:uppercase; background:rgba(76,175,80,.06); position: sticky; top:0; }
Â  tr:hover td { background:rgba(76,175,80,.07); }
Â  code.badge { background:#0e1631; border:1px solid var(--line); padding:2px 6px; border-radius:8px; }
Â  .message { padding:10px 12px; border-radius:12px; margin:8px 0; display:flex; align-items:center; gap:8px; }
Â  .message.success { color:#2fd180; background:rgba(47,209,128,.12); border:1px solid rgba(47,209,128,.35); }
Â  .message.error { color:#ff6b7a; background:rgba(255,107,122,.12); border:1px solid rgba(255,107,122,.35); }
Â  .message.warn { color:#ffa726; background:rgba(255,167,38,.12); border:1px solid rgba(255,167,38,.35); }
Â  .hide { display:none !important; }
Â  .table-actions { display:flex; gap:8px; flex-wrap:wrap; }
Â  .flex { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
Â  .spacer { flex:1; }
Â  .inline { display:inline-flex; align-items:center; gap:8px; }
Â  .capacity-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:14px; }
Â  .cap-item { background:var(--card-2); border:1px solid var(--line); border-radius:14px; padding:14px; }
Â  .progress { height:8px; background:var(--line); border-radius:4px; overflow:hidden; }
Â  .progress > div { height:8px; background:var(--gradient); }
Â  .pagination { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
Â  .pill { background:#0e1631; border:1px solid var(--line); padding:4px 10px; border-radius:999px; }
</style>
</head>
<body>
<div class="container">
Â  <div class="header">
Â  Â  <h1>ğŸ” Admin PRO â€¢ Aprofundamentos 2025.2</h1>
Â  Â  <p class="muted">GestÃ£o avanÃ§ada de inscriÃ§Ãµes, capacidade e exportaÃ§Ãµes.</p>
Â  </div>

Â  Â  <div id="loginCard" class="card">
Â  Â  <div class="card-title"><span>ğŸ”’</span> Acesso</div>
Â  Â  <div class="muted" id="apiInfo">Detectando API...</div>

Â  Â  <div id="apiEditor" class="grid grid-2 hide" style="margin-top:10px;">
Â  Â  Â  <div>
Â  Â  Â  Â  <label for="api">ğŸŒ URL da API</label>
Â  Â  Â  Â  <input id="api" placeholder="https://script.google.com/macros/s/....../exec" />
Â  Â  Â  Â  <small class="muted">VocÃª pode alterar a URL detectada aqui.</small>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="grid grid-2" style="margin-top:14px;">
Â  Â  Â  <div>
Â  Â  Â  Â  <label for="pwd">ğŸ”‘ Senha</label>
Â  Â  Â  Â  <input id="pwd" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
Â  Â  Â  Â  <small class="muted">Use a senha admin definida no GAS.</small>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="flex" style="margin-top:12px;">
Â  Â  Â  <button id="btEnter" class="btn"><span>ğŸš€</span> Entrar</button>
Â  Â  Â  <button id="toggleApi" class="btn secondary"><span>âš™ï¸</span> Configurar API</button>
Â  Â  Â  <span id="loginMsg" class="message hide" role="status" aria-live="polite"></span>
Â  Â  </div>
Â  </div>

Â  Â  <div id="dash" class="hide">
Â  Â  <div class="flex" style="justify-content:flex-end; margin-bottom:10px;">
Â  Â  Â  <button id="btLogout" class="btn secondary"><span>ğŸ‘‹</span> Sair</button>
Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  <div class="card" style="flex:1; min-width:260px;">
Â  Â  Â  Â  <div class="card-title"><span>ğŸ“Š</span> EstatÃ­sticas</div>
Â  Â  Â  Â  <div class="grid grid-3">
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div class="muted">Total de InscriÃ§Ãµes</div>
Â  Â  Â  Â  Â  Â  <div id="tot" style="font-size:2rem; font-weight:800;">-</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div class="muted">Esgotados</div>
Â  Â  Â  Â  Â  Â  <div id="esgot" style="font-size:2rem; font-weight:800;">-</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div class="muted">Ãšltima AtualizaÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  <div id="last" style="font-weight:800;">-</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card" style="flex:1.5; min-width:320px;">
Â  Â  Â  Â  <div class="card-title"><span>ğŸ”</span> Filtros</div>
Â  Â  Â  Â  <div class="grid grid-3">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="fAprof">ğŸ“š Aprofundamento</label>
Â  Â  Â  Â  Â  Â  <select id="fAprof"><option value="">Todos</option></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="fSerie">ğŸ« SÃ©rie/Turma</label>
Â  Â  Â  Â  Â  Â  <select id="fSerie">
Â  Â  Â  Â  Â  Â  Â  <option value="">Todas</option>
Â  Â  Â  Â  Â  Â  Â  <option>2Â° A</option><option>2Â° B</option><option>2Â° C</option>
Â  Â  Â  Â  Â  Â  Â  <option>3Â° A</option><option>3Â° B</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="fQ">ğŸ” Buscar por nome</label>
Â  Â  Â  Â  Â  Â  <input id="fQ" placeholder="Digite um nome..." />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="grid grid-3" style="margin-top:10px;">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="fFrom">ğŸ—“ï¸ De</label>
Â  Â  Â  Â  Â  Â  <input id="fFrom" type="date" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="fTo">ğŸ—“ï¸ AtÃ©</label>
Â  Â  Â  Â  Â  Â  <input id="fTo" type="date" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="display:flex; align-items:flex-end; gap:10px;">
Â  Â  Â  Â  Â  Â  <button id="btFiltrar" class="btn"><span>ğŸ”„</span> Aplicar</button>
Â  Â  Â  Â  Â  Â  <button id="btSort" class="btn secondary" title="Alternar ordenaÃ§Ã£o"><span>ğŸ“‹</span> Ordenar: Data/Hora</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="fltMsg" class="message hide"></div>
Â  Â  Â  Â  <div class="flex" style="margin-top:10px;">
Â  Â  Â  Â  Â  <div class="inline">
Â  Â  Â  Â  Â  Â  <label for="pageSize">Linhas por pÃ¡gina</label>
Â  Â  Â  Â  Â  Â  <select id="pageSize">
Â  Â  Â  Â  Â  Â  Â  <option>25</option><option selected>50</option><option>100</option><option>200</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="spacer"></div>
Â  Â  Â  Â  Â  <div class="inline">
Â  Â  Â  Â  Â  Â  <button id="btPDF" class="btn small"><span>ğŸ“„</span> PDF</button>
Â  Â  Â  Â  Â  Â  <button id="btXLSX" class="btn small success"><span>ğŸ“Š</span> XLSX</button>
Â  Â  Â  Â  Â  Â  <button id="btDOCX" class="btn small warn"><span>ğŸ“</span> DOC</button>
Â  Â  Â  Â  Â  Â  <button id="btCSV" class="btn small secondary"><span>ğŸ“‹</span> CSV</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:16px;">
Â  Â  Â  <div class="flex">
Â  Â  Â  Â  <div class="card-title"><span>ğŸ“‹</span> InscriÃ§Ãµes</div>
Â  Â  Â  Â  <div class="spacer"></div>
Â  Â  Â  Â  <div class="pagination">
Â  Â  Â  Â  Â  <button id="prevPage" class="btn secondary small">â—€</button>
Â  Â  Â  Â  Â  <span class="pill"><span id="pageInfo">PÃ¡gina 1/1</span></span>
Â  Â  Â  Â  Â  <button id="nextPage" class="btn secondary small">â–¶</button>
Â  Â  Â  Â  Â  <span class="pill"><span id="count">-</span></span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="loading" id="loading" style="padding:50px; text-align:center;">
Â  Â  Â  Â  <div>Carregando dadosâ€¦</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="hide" id="tblWrap">
Â  Â  Â  Â  <table id="tbl">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>ğŸ•’ Data/Hora</th>
Â  Â  Â  Â  Â  Â  Â  <th>ğŸ‘¤ Nome</th>
Â  Â  Â  Â  Â  Â  Â  <th>ğŸ« SÃ©rie/Turma</th>
Â  Â  Â  Â  Â  Â  Â  <th>ğŸ“š Aprofundamento</th>
Â  Â  Â  Â  Â  Â  Â  <th>ğŸ†” ID</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width:260px;">âš™ï¸ AÃ§Ãµes</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="tbody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="card" style="margin-top:16px;">
Â  Â  Â  <div class="card-title"><span>ğŸ“Š</span> Capacidade dos Aprofundamentos</div>
Â  Â  Â  <div id="capGrid" class="capacity-grid"></div>
Â  Â  </div>
Â  </div>
</div>

<div id="modalBackdrop" class="modal-backdrop hide">
Â  <div class="modal">
Â  Â  <div class="card-title"><span>ğŸ”</span> Transferir InscriÃ§Ã£o</div>
Â  Â  <div class="grid grid-2">
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Aluno</label>
Â  Â  Â  Â  <div id="mAluno" class="pill"></div>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>ID</label>
Â  Â  Â  Â  <div id="mId" class="pill"></div>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>De</label>
Â  Â  Â  Â  <div id="mFrom" class="pill"></div>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Para</label>
Â  Â  Â  Â  <select id="mTo"></select>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="flex" style="margin-top:12px;">
Â  Â  Â  <button id="btDoTransfer" class="btn"><span>âœ…</span> Confirmar</button>
Â  Â  Â  <button id="btCancelTransfer" class="btn secondary"><span>âœ–</span> Cancelar</button>
Â  Â  Â  <span id="mMsg" class="message hide"></span>
Â  Â  </div>
Â  </div>
</div>

<script>
/* ============ CONFIG / API AUTODETECT ============ */
const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxvbEjnVkHAslEQmj6ZwioEVSyQXzqAaVIEY3FOGDIX7HhS38qaGQ3SwfxaIrRPtLef/exec";
function withTimeout(promise, ms) { return new Promise((res, rej) => { const t=setTimeout(()=>rej(new Error('timeout')), ms); promise.then(v=>{clearTimeout(t);res(v)},e=>{clearTimeout(t);rej(e)}); }); }
function getQueryParam(name) { const u = new URL(location.href); const v = u.searchParams.get(name); return v && v.trim() ? v.trim() : null; }
async function resolveApi() {
Â  const qp = getQueryParam('api'); if (qp) return qp;
Â  const ls = localStorage.getItem('aprof_api'); if (ls) return ls;
Â  try { const r = await fetch('config.json', { cache:'no-store' }); if (r.ok) { const cfg = await r.json(); if (cfg && cfg.api) return String(cfg.api); } } catch(_){}
Â  return DEFAULT_API;
}

/* ============ ELEMENTS ============ */
const $ = s => document.querySelector(s);
const apiInfo=$('#apiInfo'), apiEditor=$('#apiEditor'), apiEl=$('#api'); const toggleApiBtn=$('#toggleApi');
const pwdEl=$('#pwd'), enterBtn=$('#btEnter'), loginCard=$('#loginCard'), loginMsg=$('#loginMsg'), dash=$('#dash');
const fAprof=$('#fAprof'), fSerie=$('#fSerie'), fQ=$('#fQ'), fFrom=$('#fFrom'), fTo=$('#fTo');
const pageSizeEl=$('#pageSize'), prevPage=$('#prevPage'), nextPage=$('#nextPage'), pageInfo=$('#pageInfo');
const btFiltrar=$('#btFiltrar'), btSort=$('#btSort'), btLogout=$('#btLogout');
const totEl=$('#tot'), esgotEl=$('#esgot'), lastEl=$('#last');
const loading=$('#loading'), tblWrap=$('#tblWrap'), tbody=$('#tbody'), count=$('#count');
const btPDF=$('#btPDF'), btXLSX=$('#btXLSX'), btDOCX=$('#btDOCX'), btCSV=$('#btCSV');
const capGrid=$('#capGrid');
// modal
const modalBackdrop=$('#modalBackdrop'); const mAluno=$('#mAluno'); const mId=$('#mId'); const mFrom=$('#mFrom'); const mTo=$('#mTo'); const mMsg=$('#mMsg'); const btDoTransfer=$('#btDoTransfer'); const btCancelTransfer=$('#btCancelTransfer');

/* ============ STATE ============ */
let TOKEN='', API=''; let baseData=[], filteredData=[], currentPage=1, sortMode='ts', capacidade=[];
let listController, statsController;

/* ============ SESSION ============ */
function setSession(a,t){ sessionStorage.setItem('aprof_api', a); sessionStorage.setItem('aprof_token', t); }
function restoreSession(){ const a=sessionStorage.getItem('aprof_api'), t=sessionStorage.getItem('aprof_token'); if(a && t){ API=a; TOKEN=t; return true; } return false; }

/* ============ UI HELPERS ============ */
function showMessage(el, text, type='error'){ el.textContent=text; el.className = 'message ' + (type==='success'?'success':type==='warn'?'warn':'error'); el.classList.remove('hide'); if(type==='success'){ setTimeout(()=>el.classList.add('hide'), 2500);} }
function hideMessage(el){ el.classList.add('hide'); }
function fmtDate(iso){ try{ return new Date(iso).toLocaleString('pt-BR'); } catch(_){ return iso||''; } }
function parseDateOnly(val){ if(!val) return null; const d = new Date(val + 'T00:00:00'); return isNaN(+d) ? null : d; }
function inDateRange(tsIso, from, to){ if(!from && !to) return true; const t = tsIso ? new Date(tsIso) : null; if(!t) return false; if(from && t < from) return false; if(to){ const end = new Date(to); end.setHours(23,59,59,999); if(t > end) return false; } return true; }

/* ============ FETCH HELPERS ============ */
async function authedGet(url, params={}, extra={}){ const u=new URL(url); Object.keys(params).forEach(k=>{ const v=params[k]; if(v!=null && v!=='') u.searchParams.append(k,v); }); u.searchParams.append('key', TOKEN);
Â  const res=await fetch(u.toString(), { signal: extra.signal }); const text=await res.text(); let json; try{ json=JSON.parse(text); }catch(e){ throw new Error('Resposta nÃ£o-JSON: '+text.substring(0,120)); } if(!res.ok || json.ok===false) throw new Error(json.error || ('HTTP '+res.status)); return json; }
async function authedPost(url, body={}, extra={}){ const u=new URL(url); u.searchParams.append('key', TOKEN);
Â  const res=await fetch(u.toString(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), signal: extra.signal });
Â  const text=await res.text(); let json; try{ json=JSON.parse(text); }catch(e){ throw new Error('Resposta nÃ£o-JSON: '+text.substring(0,120)); } if(!res.ok || json.ok===false) throw new Error(json.error || ('HTTP '+res.status)); return json; }

/* ============ LOADERS ============ */
async function loadStats(){ if(statsController) statsController.abort(); statsController = new AbortController(); return authedGet(API, { stats:'1' }, { signal: statsController.signal }); }
async function loadList(params={}){ if(listController) listController.abort(); listController = new AbortController();
Â  const q={ list:'1' }; if(params.aprofundamento) q.aprofundamento=params.aprofundamento; if(params.serie) q.serie=params.serie; if(params.q) q.q=params.q;
Â  return authedGet(API, q, { signal: listController.signal });
}

/* ============ RENDERERS ============ */
function renderStats(s){ 
Â  totEl.textContent = s.totalInscricoes || 0; 
Â  lastEl.textContent = new Date().toLocaleTimeString('pt-BR'); 
Â  capacidade = s.capacidade || []; 
Â  esgotEl.textContent = capacidade.filter(c => (+c.restantes||0)===0).length;

Â  // select de aprofundamentos
Â  fAprof.innerHTML = '<option value=\"\">Todos</option>' + capacidade.map(c => `<option value="${c.aprofundamento}">${c.aprofundamento} (${c.restantes} restantes)</option>`).join('');

Â  // grid de capacidade com ediÃ§Ã£o de limite
Â  capGrid.innerHTML = '';
Â  capacidade.forEach(c => { 
Â  Â  const pct = c.limite>0 ? Math.min((c.inscritos/c.limite)*100, 100) : 0;
Â  Â  const div=document.createElement('div'); 
Â  Â  div.className='cap-item';
Â  Â  div.innerHTML = `<div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
Â  Â  Â  Â  <strong>${c.aprofundamento}</strong>
Â  Â  Â  Â  <span class="pill">${c.inscritos}/${c.limite} Â· ${c.restantes} vagas</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="progress" style="margin:8px 0 10px;"><div style="width:${pct}%"></div></div>
Â  Â  Â  <div class="flex">
Â  Â  Â  Â  <div class="inline">
Â  Â  Â  Â  Â  <label>Limite</label>
Â  Â  Â  Â  Â  <input type="number" min="0" value="${c.limite}" style="width:120px" data-aprof="${c.aprofundamento}" class="cap-limit"/>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="spacer"></div>
Â  Â  Â  Â  <button class="btn small success btSetLimit" data-aprof="${c.aprofundamento}">Salvar limite</button>
Â  Â  Â  </div>`;
Â  Â  capGrid.appendChild(div);
Â  });
}

function applyClientFilters(rows){
Â  const q = (fQ.value||'').trim().toLowerCase(); const serie = fSerie.value||''; const aprof = fAprof.value||'';
Â  const from = parseDateOnly(fFrom.value); const to = parseDateOnly(fTo.value);
Â  let data = rows.filter(r => {
Â  Â  if(aprof && r.aprofundamento !== aprof) return false;
Â  Â  if(serie && r.serie !== serie) return false;
Â  Â  if(q && !String(r.nome||'').toLowerCase().includes(q)) return false;
Â  Â  if(!inDateRange(r.ts, from, to)) return false;
Â  Â  return true;
Â  });
Â  // sort
Â  if(sortMode==='nome'){ data.sort((a,b)=> (a.nome||'').localeCompare(b.nome||'', 'pt-BR', { sensitivity:'base' })); }
Â  else { data.sort((a,b)=> (a.ts<b.ts?1:-1)); }
Â  return data;
}

function renderTable(paged){
Â  tbody.innerHTML = '';
Â  const frag = document.createDocumentFragment();
Â  paged.forEach(r => {
Â  Â  const tr = document.createElement('tr');
Â  Â  const tds = [
Â  Â  Â  fmtDate(r.ts),
Â  Â  Â  `<strong>${r.nome||''}</strong>`,
Â  Â  Â  r.serie||'',
Â  Â  Â  r.aprofundamento||'',
Â  Â  Â  `<code class="badge">${r.id||''}</code>`,
Â  Â  Â  `<div class="table-actions">
Â  Â  Â  Â  Â <button class="btn small" data-id="${r.id}" data-nome="${r.nome}" data-from="${r.aprofundamento}" onclick="openTransfer(event)">ğŸ” Transferir</button>
Â  Â  Â  Â  Â <button class="btn small danger" data-id="${r.id}" data-from="${r.aprofundamento}" onclick="deleteRow(event)">ğŸ—‘ï¸ Excluir</button>
Â  Â  Â  Â </div>`
Â  Â  ];
Â  Â  tds.forEach(html => { const td=document.createElement('td'); td.innerHTML=html; tr.appendChild(td); });
Â  Â  frag.appendChild(tr);
Â  });
Â  tbody.appendChild(frag);
}

function paginate(data){
Â  const size = parseInt(pageSizeEl.value,10)||50; const total = data.length; const pages = Math.max(1, Math.ceil(total/size));
Â  currentPage = Math.min(currentPage, pages);
Â  const start = (currentPage-1)*size; const end = Math.min(start+size, total);
Â  const pageData = data.slice(start, end);
Â  pageInfo.textContent = `PÃ¡gina ${currentPage}/${pages}`;
Â  count.textContent = `${total} registro(s)`;
Â  prevPage.disabled = (currentPage<=1); nextPage.disabled = (currentPage>=pages);
Â  return pageData;
}

/* ============ EXPORTS ============ */
function exportToPDF(rows){ 
Â  const { jsPDF } = window.jspdf; 
Â  const doc = new jsPDF(); 
Â  doc.setFontSize(16);
Â  doc.text('Aprofundamentos 2025.2 - InscriÃ§Ãµes', 14, 20);
Â  doc.setFontSize(10);
Â  doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 30);
Â  const headers = [['Data/Hora','Nome','SÃ©rie/Turma','Aprofundamento','ID']];
Â  const body = rows.map(r => [fmtDate(r.ts), r.nome, r.serie, r.aprofundamento, r.id]);
Â  doc.autoTable({ head: headers, body, startY: 40, styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [76,175,80], textColor: 255 } });
Â  doc.save(`aprofundamentos_${new Date().toISOString().split('T')[0]}.pdf`);
}
function exportToXLSX(rows){ 
Â  const data = [['Data/Hora','Nome','SÃ©rie/Turma','Aprofundamento','ID'], ...rows.map(r => [fmtDate(r.ts), r.nome, r.serie, r.aprofundamento, r.id])];
Â  const wb = XLSX.utils.book_new(); 
Â  const ws = XLSX.utils.aoa_to_sheet(data); 
Â  ws['!cols'] = [{ width: 20 }, { width: 30 }, { width: 16 }, { width: 40 }, { width: 18 }];
Â  XLSX.utils.book_append_sheet(wb, ws, 'InscriÃ§Ãµes'); 
Â  XLSX.writeFile(wb, `aprofundamentos_${new Date().toISOString().split('T')[0]}.xlsx`);
}
function exportToDOC(rows){ 
Â  let html = `<html><head><meta charset='utf-8'><title>InscriÃ§Ãµes</title></head><body>`;
Â  html += `<h1 style='text-align:center;color:#4CAF50'>Aprofundamentos 2025.2</h1><p>Gerado em ${new Date().toLocaleString('pt-BR')}</p>`;
Â  html += `<table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;width:100%'><thead><tr><th>Data/Hora</th><th>Nome</th><th>SÃ©rie/Turma</th><th>Aprofundamento</th><th>ID</th></tr></thead><tbody>`;
Â  rows.forEach(r => html += `<tr><td>${fmtDate(r.ts)}</td><td>${r.nome||''}</td><td>${r.serie||''}</td><td>${r.aprofundamento||''}</td><td>${r.id||''}</td></tr>`);
Â  html += `</tbody></table></body></html>`; 
Â  const blob = new Blob([html], { type:'application/msword' }); 
Â  saveAs(blob, `aprofundamentos_${new Date().toISOString().split('T')[0]}.doc`);
}
function exportToCSV(rows){ 
Â  const headers=['Data/Hora','Nome','SÃ©rie/Turma','Aprofundamento','ID']; 
Â  const lines=[headers.join(';')];
Â  rows.forEach(r => { 
Â  Â  const vals=[fmtDate(r.ts), r.nome||'', r.serie||'', r.aprofundamento||'', r.id||''].map(v=>String(v).replace(/"/g,'""')); 
Â  Â  lines.push(vals.map(v => (/[",\n;]/.test(v) ? `"${v}"` : v)).join(';')); 
Â  });
Â  const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' }); 
Â  saveAs(blob, `aprofundamentos_${new Date().toISOString().split('T')[0]}.csv`);
}

/* ============ ADMIN ACTIONS (PRO) ============ */
async function setLimit(aprof, limit){ return authedPost(API, { action:'setLimit', aprofundamento: aprof, limite: Number(limit) }); }
async function transfer(id, novo){ return authedPost(API, { action:'transfer', id, novoAprofundamento: novo }); }
async function removeById(id){ return authedPost(API, { action:'delete', id }); }

/* ============ EVENT HANDLERS ============ */
function wireCapacityButtons(){
Â  document.querySelectorAll('.btSetLimit').forEach(btn => btn.addEventListener('click', async (e) => { 
Â  Â  const aprof=e.currentTarget.dataset.aprof;
Â  Â  const input = document.querySelector(`input.cap-limit[data-aprof="${CSS.escape(aprof)}"]`); 
Â  Â  const val = input ? Number(input.value) : NaN;
Â  Â  if(isNaN(val) || val<0) return alert('Informe um limite vÃ¡lido');
Â  Â  try{ 
Â  Â  Â  await setLimit(aprof, val); 
Â  Â  Â  showMessage($('#fltMsg'), 'Limite atualizado para "'+aprof+'"', 'success'); 
Â  Â  Â  const s = await loadStats(); renderStats(s); 
Â  Â  }catch(err){ alert('Erro ao definir limite: '+err.message); }
Â  }));
}

function openTransfer(ev){ 
Â  const b=ev.currentTarget; const id=b.dataset.id; const nome=b.dataset.nome; const from=b.dataset.from;
Â  mAluno.textContent = nome; mId.textContent = id; mFrom.textContent = from; mMsg.classList.add('hide');
Â  // opÃ§Ãµes destino
Â  mTo.innerHTML = capacidade.map(c => `<option value="${c.aprofundamento}" ${from===c.aprofundamento?'disabled':''}>${c.aprofundamento} (${c.restantes} vagas)</option>`).join('');
Â  modalBackdrop.classList.remove('hide'); 
}

async function deleteRow(ev){ 
Â  const b=ev.currentTarget; const id=b.dataset.id; const from=b.dataset.from;
Â  if(!confirm('Confirmar exclusÃ£o da inscriÃ§Ã£o '+id+'? A vaga de "'+from+'" serÃ¡ devolvida.')) return;
Â  try{ 
Â  Â  await removeById(id); 
Â  Â  showMessage($('#fltMsg'), 'InscriÃ§Ã£o removida com sucesso.', 'success'); 
Â  Â  const [s,l] = await Promise.all([loadStats(), loadList({ aprofundamento:fAprof.value||'', serie:fSerie.value||'', q:(fQ.value||'').trim() })]); 
Â  Â  renderStats(s); baseData=l.rows||[]; refreshTable(); 
Â  } catch(err){ alert('Erro ao excluir: '+err.message); }
}

btDoTransfer.addEventListener('click', async () => { 
Â  const id=mId.textContent; const novo = mTo.value;
Â  try{ 
Â  Â  await transfer(id, novo); 
Â  Â  showMessage(mMsg, 'TransferÃªncia concluÃ­da!', 'success'); 
Â  Â  setTimeout(()=>{ modalBackdrop.classList.add('hide'); }, 700);
Â  Â  const [s,l] = await Promise.all([loadStats(), loadList({ aprofundamento:fAprof.value||'', serie:fSerie.value||'', q:(fQ.value||'').trim() })]); 
Â  Â  renderStats(s); baseData=l.rows||[]; refreshTable();
Â  }catch(err){ showMessage(mMsg, 'Erro: '+err.message, 'error'); }
});
btCancelTransfer.addEventListener('click', () => modalBackdrop.classList.add('hide'));
window.openTransfer = openTransfer; window.deleteRow = deleteRow;

/* ============ TABLE FLOW ============ */
function refreshTable(){ filteredData = applyClientFilters(baseData); const pageData = paginate(filteredData); renderTable(pageData); wireCapacityButtons(); }

/* ============ BOOT ============ */
document.addEventListener('DOMContentLoaded', () => { 
Â  apiInfo.textContent = 'Detectando API...'; 
Â  apiEditor.classList.add('hide');
Â  (async () => { 
Â  Â  try{ 
Â  Â  Â  const detected = await withTimeout(resolveApi(), 2000); 
Â  Â  Â  API = detected || DEFAULT_API; 
Â  Â  Â  apiEl.value = API; 
Â  Â  Â  apiInfo.textContent = 'API detectada: '+API+' â€” clique em âš™ï¸ para alterar.'; 
Â  Â  }
Â  Â  catch(e){ 
Â  Â  Â  API = getQueryParam('api') || localStorage.getItem('aprof_api') || DEFAULT_API; 
Â  Â  Â  apiEl.value = API; 
Â  Â  Â  apiInfo.textContent = 'NÃ£o foi possÃ­vel detectar automaticamente. Informe a URL abaixo.'; 
Â  Â  Â  apiEditor.classList.remove('hide'); 
Â  Â  Â  setTimeout(()=>apiEl.focus(),0); 
Â  Â  }
Â  Â  if (restoreSession()) { API = API || sessionStorage.getItem('aprof_api'); enterBtn.click(); }
Â  })();
});

toggleApiBtn.addEventListener('click', () => apiEditor.classList.toggle('hide'));

enterBtn.addEventListener('click', async () => { 
Â  API = (apiEl.value||'').trim() || API; 
Â  TOKEN = (pwdEl.value||'').trim();
Â  if(!API) return showMessage(loginMsg, 'Informe a URL da API.', 'error');
Â  if(!TOKEN) return showMessage(loginMsg, 'Informe a senha.', 'error');
Â  enterBtn.disabled = true; enterBtn.textContent = 'Validando...'; showMessage(loginMsg, 'Validando credenciais...', 'warn');
Â  try{ 
Â  Â  const stats = await loadStats(); 
Â  Â  setSession(API, TOKEN); 
Â  Â  localStorage.setItem('aprof_api', API);
Â  Â  loginCard.classList.add('hide'); 
Â  Â  dash.classList.remove('hide'); 
Â  Â  renderStats(stats);
Â  Â  loading.classList.remove('hide'); 
Â  Â  tblWrap.classList.add('hide');
Â  Â  const lst = await loadList({}); 
Â  Â  baseData = lst.rows || []; 
Â  Â  refreshTable();
Â  Â  loading.classList.add('hide'); 
Â  Â  tblWrap.classList.remove('hide'); 
Â  Â  hideMessage(loginMsg);
Â  }catch(err){ 
Â  Â  showMessage(loginMsg, 'Falha no acesso: '+err.message, 'error'); 
Â  } finally { 
Â  Â  enterBtn.disabled = false; 
Â  Â  enterBtn.textContent = 'Entrar'; 
Â  }
});

btFiltrar.addEventListener('click', async () => { 
Â  btFiltrar.disabled = true; btFiltrar.textContent = 'Atualizando...';
Â  try{ 
Â  Â  const [s,l] = await Promise.all([loadStats(), loadList({ aprofundamento:fAprof.value||'', serie:fSerie.value||'', q:(fQ.value||'').trim() })]); 
Â  Â  renderStats(s); baseData=l.rows||[]; refreshTable(); 
Â  Â  showMessage($('#fltMsg'), 'Filtros aplicados!', 'success'); 
Â  }catch(err){ 
Â  Â  showMessage($('#fltMsg'), 'Erro: '+err.message, 'error'); 
Â  } finally { 
Â  Â  btFiltrar.disabled = false; 
Â  Â  btFiltrar.textContent = 'Aplicar'; 
Â  }
});
btSort.addEventListener('click', () => { sortMode = sortMode==='ts' ? 'nome' : 'ts'; btSort.innerHTML = sortMode==='ts' ? '<span>ğŸ“‹</span> Ordenar: Data/Hora' : '<span>ğŸ“‹</span> Ordenar: Nome (Aâ†’Z)'; refreshTable(); });
pageSizeEl.addEventListener('change', () => { currentPage=1; refreshTable(); });
prevPage.addEventListener('click', () => { if(currentPage>1){ currentPage--; refreshTable(); } });
nextPage.addEventListener('click', () => { currentPage++; refreshTable(); });

btPDF.addEventListener('click', () => exportToPDF(filteredData));
btXLSX.addEventListener('click', () => exportToXLSX(filteredData));
btDOCX.addEventListener('click', () => exportToDOC(filteredData));
btCSV.addEventListener('click', () => exportToCSV(filteredData));

pwdEl.addEventListener('keydown', e => { if(e.key==='Enter') enterBtn.click(); });
fQ.addEventListener('keydown', e => { if(e.key==='Enter') btFiltrar.click(); });

btLogout?.addEventListener('click', () => { 
Â  sessionStorage.removeItem('aprof_api'); 
Â  sessionStorage.removeItem('aprof_token'); 
Â  TOKEN=''; 
Â  dash.classList.add('hide'); 
Â  loginCard.classList.remove('hide'); 
Â  showMessage(loginMsg, 'SessÃ£o encerrada.', 'success'); 
});
</script>
</body>
</html>
