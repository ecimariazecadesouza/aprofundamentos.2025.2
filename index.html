<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aprofundamentos 2025.2</title>
  <style>
    /* Estilo permanece o mesmo */
  </style>
</head>
<body>
  <div class="card">
    <header>
      <h1>🎓 Aprofundamentos 2025.2</h1>
      <p class="sub">Preencha o formulário abaixo para garantir sua vaga.<br>
      <strong>Cada aprofundamento tem limite de vagas</strong> - não perca tempo!</p>
    </header>

    <form id="form">
      <div class="field">
        <label for="nome">👤 Nome Completo</label>
        <input id="nome" name="nome" type="text" placeholder="Digite seu nome completo" required />
        <div class="hint">Informe seu nome completo conforme documentos oficiais</div>
      </div>

      <div class="row">
        <div class="field">
          <label for="serie">🏫 Série/Turma</label>
          <select id="serie" name="serie" required>
            <option value="" disabled selected>Selecione sua turma</option>
            <option>2° A</option><option>2° B</option><option>2° C</option>
            <option>3° A</option><option>3° B</option>
          </select>
          <div class="hint">Escolha sua série e turma atual</div>
        </div>

        <div class="field">
          <label for="aprof"><span class="icon-wrapper">🔍</span> Aprofundamento</label>
          <select id="aprof" name="aprof" required>
            <option value="" disabled selected>Carregando opções...</option>
          </select>
          <div class="hint">Aprofundamentos esgotados ficam indisponíveis</div>
        </div>
      </div>

      <div class="chips-container">
        <div class="chips-title"><span class="icon-wrapper">📊</span> Vagas Disponíveis</div>
        <div class="chips" id="chips"></div>
      </div>
      
      <div id="status" class="status" role="status" aria-live="polite"></div>
      <button id="btn" type="submit">
        <span class="icon-wrapper">✅</span> Confirmar Inscrição
      </button>
    </form>

    <div class="footer">
      <span><span class="icon-wrapper">📚</span> ECI Maria Zeca de Souza • Aprofundamentos 2025.2 • Lkton • 2025</span>
      <div class="sync-indicator">
        <div class="sync-dot"></div>
        <span id="lastSync">Sincronizando...</span>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxvbEjnVkHAslEQmj6ZwioEVSyQXzqAaVIEY3FOGDIX7HhS38qaGQ3SwfxaIrRPtLef/exec";

    // Função para carregar os dados de disponibilidade
    async function loadAvailability() {
      try {
        const res = await fetch(API_URL, {
          method: 'GET',
          mode: 'cors',  // A requisição agora usa 'cors' para garantir que os dados sejam acessados corretamente
        });

        const data = await res.json();
        if (data.ok && data.availability) {
          renderOptions(data.availability);  // Renderizar as opções de Aprofundamento
          renderChips(data.availability);  // Exibir chips de disponibilidade
          lastSync.textContent = "Atualizado " + new Date().toLocaleTimeString('pt-BR');
        } else {
          setStatus("⚠️ Falha ao carregar os aprofundamentos.", "error");
        }
      } catch (err) {
        console.error("Erro ao carregar disponibilidade:", err);
        setStatus("⚠️ Usando dados locais. A conexão com o servidor falhou.", "warning");
        lastSync.textContent = "Dados locais";
      }
    }

    // Renderiza as opções de aprofundamento com base na série escolhida
    function renderOptions(items) {
      const serie = inpSerie.value;
      const filtered = items.filter(item => item.series.includes(serie));

      const selAprof = document.getElementById("aprof");
      selAprof.innerHTML = '';  // Limpa as opções de aprofundamento
      const opt0 = document.createElement('option');
      opt0.value = ''; 
      opt0.disabled = true; 
      opt0.selected = true;
      opt0.textContent = 'Selecione um aprofundamento';
      selAprof.appendChild(opt0);

      filtered.forEach(item => {
        const o = document.createElement("option");
        o.value = item.nome;
        o.textContent = `${item.nome} (${item.vagas} vagas)`;
        selAprof.appendChild(o);
      });
    }

    // Renderiza os chips de vagas disponíveis
    function renderChips(items) {
      const serie = inpSerie.value;
      const filtered = items.filter(item => item.series.includes(serie));

      const chips = document.getElementById("chips");
      chips.innerHTML = "";  // Limpa os chips de vagas disponíveis

      filtered.forEach(item => {
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = `${item.nome} (${item.vagas} vagas)`;
        chips.appendChild(pill);
      });
    }

    // Exibe o status de erro ou sucesso
    function setStatus(msg, type) {
      const statusBox = document.getElementById("status");
      statusBox.textContent = msg;
      statusBox.className = `status ${type}`;
      statusBox.style.display = 'block';
    }

    // Carregar os dados assim que a página for carregada
    window.addEventListener('DOMContentLoaded', () => {
      loadAvailability();
    });

    // Eventos para o formulário
    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value.trim();
      const serie = document.getElementById("serie").value;
      const aprofundamento = document.getElementById("aprof").value;

      if (!nome || !serie || !aprofundamento) {
        setStatus("⚠️ Por favor, preencha todos os campos obrigatórios.", "error");
        return;
      }

      setStatus("🎉 Inscrição registrada com sucesso!", "success");
      // Resetando o formulário
      document.getElementById('form').reset();
      loadAvailability(); // Recarrega os aprofundamentos
    });
  </script>
</body>
</html>
